package com.mysite.weather.user;

import java.security.Principal;

import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;

@RequiredArgsConstructor
@Controller
@RequestMapping("/user")
public class UserController {
	private final UserService userService;
	
	@GetMapping("/signup")
	public String signup(UserCreateForm userCreateForm) {
		return "signup_form";
	}
	
	@PostMapping("/signup")
	public String signup(@Valid UserCreateForm userCreateForm, BindingResult bindingResult) {
		if(bindingResult.hasErrors()) {
			return "signup_form";
		}
		
		if(!userCreateForm.getPassword1().equals(userCreateForm.getPassword2())) {
			bindingResult.rejectValue("password2", "passwordInCorrect", "2ê°œì˜ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
			return "signup_form";
		}
		
		try{
        	userService.create(userCreateForm.getUsername(), 
            userCreateForm.getEmail(), userCreateForm.getPassword1());
        }catch(DataIntegrityViolationException e) {
        	e.printStackTrace();
        	bindingResult.reject("signupFailed", "ì´ë¯¸ ë“±ë¡ëœ ì‚¬ìš©ìì…ë‹ˆë‹¤.");
        	return "signup_form";
        }catch(Exception e) {
        	e.printStackTrace();
        	bindingResult.reject("signupFailed" , e.getMessage());
        	return "signup_form";
        }
		return "redirect:/";
	}
	
	@GetMapping("/login")
	public String login() {
		return "login_form";
	}
	
	@GetMapping("/profile")
	public String profile(Principal principal, Model model, RedirectAttributes redirectAttributes) {
	    // ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ì ì²˜ë¦¬
	    if (principal == null) {
	        return "redirect:/user/login";  // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
	    }

	    // Principal ê°ì²´ì—ì„œ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ usernameì„ ê°€ì ¸ì˜´
	    String username = principal.getName();

	    // UserServiceë¥¼ í†µí•´ ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°íšŒ
	    SiteUser user = userService.findByUsername(username);

	    // ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš° ì²˜ë¦¬
	    if (user == null) {
	        redirectAttributes.addFlashAttribute("errorMessage", "ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
	        return "redirect:/user/signup"; 
	    }

	    // ëª¨ë¸ì— ì‚¬ìš©ì ì •ë³´ë¥¼ ì¶”ê°€í•˜ì—¬ ë·°ë¡œ ì „ë‹¬
	    model.addAttribute("user", user);

	    return "user_profile";  // ì‚¬ìš©ì í”„ë¡œí•„ í™”ë©´ìœ¼ë¡œ ì´ë™
	}
	
	@GetMapping("/profile")
	public String profile(Principal principal, Model model, 
	                      @ModelAttribute("message") String message,
	                      @ModelAttribute("errorMessage") String errorMessage) {
	    if (principal == null) {
	        return "redirect:/user/login";
	    }

	    String username = principal.getName();
	    SiteUser user = userService.findByUsername(username);

	    if (user == null) {
	        return "redirect:/user/signup";
	    }

	    model.addAttribute("user", user);
	    
	    // ğŸ”½ FlashAttribute ë©”ì‹œì§€ë¥¼ ëª¨ë¸ì— ì¶”ê°€ (ìƒëµí•´ë„ ë˜ì§€ë§Œ ëª…ì‹œì ìœ¼ë¡œ í•˜ë©´ ë””ë²„ê¹…ì— ì¢‹ìŒ)
	    if (message != null) model.addAttribute("message", message);
	    if (errorMessage != null) model.addAttribute("errorMessage", errorMessage);

	    return "user_profile"; // ìˆ˜ì •ëœ í”„ë¡œí•„ í˜ì´ì§€
	}
	
	
	@PostMapping("/profile/edit")
	public String updateProfile(
	        Principal principal,
	        @RequestParam("email") String email,
	        @RequestParam("currentPassword") String currentPassword,
	        @RequestParam(value = "password1", required = false) String password1,
	        @RequestParam(value = "password2", required = false) String password2,
	        RedirectAttributes redirectAttributes) {

	    if (principal == null) {
	        return "redirect:/user/login";
	    }

	    String username = principal.getName();
	    SiteUser user = userService.findByUsername(username);

	    if (user == null) {
	        redirectAttributes.addFlashAttribute("errorMessage", "ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
	        return "redirect:/user/signup";
	    }

	    // 1ï¸âƒ£ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ë§ëŠ”ì§€ ê²€ì¦
	    if (!userService.checkPassword(user, currentPassword)) {
	        redirectAttributes.addFlashAttribute("errorMessage", "í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
	        return "redirect:/user/profile/edit";
	    }

	    // 2ï¸âƒ£ ì´ë©”ì¼ ìˆ˜ì •
	    user.setEmail(email);

	    // 3ï¸âƒ£ ìƒˆ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ìš”ì²­ì´ ìˆì„ ê²½ìš°
	    if (password1 != null && !password1.isEmpty()) {
	        if (!password1.equals(password2)) {
	            redirectAttributes.addFlashAttribute("errorMessage", "ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
	            return "redirect:/user/profile/edit";
	        }
	        userService.updatePassword(user, password1);
	    }

	    // 4ï¸âƒ£ ì €ì¥
	    userService.save(user);
	    redirectAttributes.addFlashAttribute("message", "ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
	    return "redirect:/user/profile";
	}
}
